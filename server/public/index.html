<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC Visualizer</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
    }
    h1 {
      color: #7c3aed;
      font-size: 1.2em;
      margin: 0;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      margin-left: 12px;
    }
    .status.connected { background: #22c55e; color: #000; }
    .status.disconnected { background: #ef4444; color: #fff; }

    /* „Çª„ÉÉ„Ç∑„Éß„É≥ */
    .sessions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 800px;
    }
    .session {
      background: #111;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #7c3aed;
    }
    .session-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .session-project {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
    }
    .session-id {
      font-size: 0.75em;
      color: #555;
      font-family: monospace;
    }
    .session-title {
      font-size: 0.9em;
      color: #bbb;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .session-action {
      color: #888;
      font-size: 0.9em;
      margin-bottom: 12px;
      padding-left: 12px;
      border-left: 2px solid #333;
    }
    .speech-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .session-speech {
      background: #1a1a2e;
      color: #e0e0e0;
      font-size: 0.95em;
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
      border: 1px solid #2a2a4e;
      animation: speechFadeIn 0.3s ease-out;
      transition: opacity 0.5s ease, transform 0.3s ease;
    }
    .session-speech.older {
      font-size: 0.85em;
      padding: 6px 10px;
      background: #151525;
    }
    .session-speech::before {
      content: '"';
      font-size: 1.2em;
      color: #7c3aed;
      margin-right: 4px;
    }
    .session-speech::after {
      content: '"';
      font-size: 1.2em;
      color: #7c3aed;
      margin-left: 4px;
    }
    @keyframes speechFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà */
    .subagents {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-left: 12px;
    }
    .subagent {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
    }
    .subagent.inactive {
      opacity: 0.4;
    }
    .subagent-type {
      font-size: 0.8em;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      min-width: 60px;
      text-align: center;
    }
    .subagent-type.Explore { background: #8b5cf6; color: #fff; }
    .subagent-type.Plan { background: #f59e0b; color: #000; }
    .subagent-type.Bash { background: #3b82f6; color: #fff; }
    .subagent-type.unknown { background: #666; color: #fff; }
    .subagent-action {
      color: #aaa;
      font-size: 0.85em;
      flex: 1;
    }
    .subagent-speech {
      background: #1a2a1a;
      color: #c0e0c0;
      font-size: 0.9em;
      padding: 8px 12px;
      border-radius: 10px;
      margin-top: 6px;
      border: 1px solid #2a4a2a;
    }
    .subagent-speech::before {
      content: 'üí≠ ';
      font-size: 0.9em;
    }
    .subagent-status {
      font-size: 0.7em;
      color: #666;
    }

    .no-sessions {
      color: #555;
      font-size: 0.9em;
      text-align: center;
      padding: 40px;
    }

    /* „Ç§„Éô„É≥„Éà„É≠„Ç∞ÔºàÂ∞è„Åï„Åè‰∏ã„Å´Ôºâ */
    .event-log {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #222;
    }
    .event-log h2 {
      font-size: 0.8em;
      color: #555;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .events {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8em;
      color: #666;
      max-height: 200px;
      overflow-y: auto;
    }
    .event {
      padding: 4px 8px;
      background: #111;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CC Visualizer</h1>
    <span id="status" class="status disconnected">disconnected</span>
  </header>

  <div id="sessions" class="sessions">
    <div class="no-sessions">„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó</div>
  </div>

  <div class="event-log">
    <h2>Event Log</h2>
    <div id="events" class="events"></div>
  </div>

  <script>
    const sessionsEl = document.getElementById('sessions');
    const eventsEl = document.getElementById('events');
    const statusEl = document.getElementById('status');
    const MAX_EVENTS = 20;

    // „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã
    const sessions = new Map();

    function connect() {
      const ws = new WebSocket(`ws://${location.host}/ws`);

      ws.onopen = () => {
        statusEl.textContent = 'connected';
        statusEl.className = 'status connected';
      };

      ws.onclose = () => {
        statusEl.textContent = 'disconnected';
        statusEl.className = 'status disconnected';
        setTimeout(connect, 2000);
      };

      ws.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);

          // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºàÂàùÊúüÁä∂ÊÖãÔºâ
          if (data.sessions) {
            sessions.clear();
            for (const session of data.sessions) {
              sessions.set(session.id, session);
            }
            renderSessions();
            return;
          }

          // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
          if (data.type === 'title_update') {
            const session = sessions.get(data.sessionId);
            if (session) {
              session.title = data.title;
              session.lastSeen = Date.now();
              renderSessions();
            }
            return;
          }

          // Áô∫Ë©±Êõ¥Êñ∞
          if (data.type === 'speech_update') {
            const session = sessions.get(data.sessionId);
            if (session) {
              // Â±•Ê≠¥„Å´ËøΩÂä†ÔºàÂêå„ÅòÂÜÖÂÆπ„ÅØËøΩÂä†„Åó„Å™„ÅÑÔºâ
              if (!session.speechHistory) {
                session.speechHistory = [];
              }
              const lastSpeech = session.speechHistory[0];
              if (!lastSpeech || lastSpeech.text !== data.speech) {
                session.speechHistory.unshift({
                  text: data.speech,
                  time: Date.now()
                });
                // ÊúÄÂ§ß3‰ª∂‰øùÊåÅ
                if (session.speechHistory.length > 3) {
                  session.speechHistory.pop();
                }
              }
              session.lastSeen = Date.now();
              renderSessions();
            }
            return;
          }

          // ÈÄöÂ∏∏„Ç§„Éô„É≥„Éà
          handleEvent(data);
          addEventToLog(data);
        } catch (err) {
          console.error('Parse error:', err);
        }
      };
    }

    function handleEvent(event) {
      const sessionId = event.session_id;
      if (!sessionId) return;

      let session = sessions.get(sessionId);
      if (!session) {
        session = {
          id: sessionId,
          projectName: extractProjectName(event.cwd),
          subAgents: [],
          lastSeen: Date.now(),
        };
        sessions.set(sessionId, session);
      }
      session.lastSeen = Date.now();

      switch (event.hook_event_name) {
        case 'SubagentStart':
          if (event.agent_id) {
            // Êó¢Â≠ò„ÅÆ„ÇíÊé¢„Åô
            let sub = session.subAgents.find(s => s.id === event.agent_id);
            if (!sub) {
              sub = { id: event.agent_id, type: event.agent_type || 'unknown', status: 'active' };
              session.subAgents.push(sub);
            } else {
              sub.status = 'active';
              sub.type = event.agent_type || sub.type;
            }
          }
          break;

        case 'SubagentStop':
          if (event.agent_id) {
            const sub = session.subAgents.find(s => s.id === event.agent_id);
            if (sub) {
              sub.status = 'inactive';
              sub.currentAction = null;
            }
          }
          break;

        case 'PreToolUse':
          const action = extractAction(event);
          if (event.agent_id) {
            const sub = session.subAgents.find(s => s.id === event.agent_id);
            if (sub && action) {
              sub.currentAction = action;
              sub.actionTime = Date.now();
            }
          } else if (action) {
            session.currentAction = action;
            session.actionTime = Date.now();
          }
          break;

        case 'PostToolUse':
          // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊ∂à„Åï„Å™„ÅÑÔºàÂêπ„ÅçÂá∫„Åó„ÅÆ„Çà„ÅÜ„Å´ÊÆã„ÅôÔºâ
          break;

        case 'SessionEnd':
          session.ended = true;
          session.currentAction = null;
          session.subAgents.forEach(s => {
            s.status = 'inactive';
            s.currentAction = null;
          });
          break;
      }

      renderSessions();
    }

    function extractProjectName(cwd) {
      if (!cwd) return 'unknown';
      const parts = cwd.split('/');
      return parts[parts.length - 1] || 'unknown';
    }

    // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂè§„Åï„Å´Âøú„Åò„Å¶opacity„ÇíË®àÁÆóÔºà10Áßí„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÈñãÂßã„ÄÅ30Áßí„ÅßÊ∂à„Åà„ÇãÔºâ
    function getActionOpacity(actionTime) {
      if (!actionTime) return 0.3;
      const age = Date.now() - actionTime;
      if (age < 10000) return 1; // 10Áßí‰ª•ÂÜÖ„ÅØ100%
      if (age > 30000) return 0.3; // 30Áßí‰ª•‰∏ä„ÅØ30%
      // 10-30Áßí„ÅØÂæê„ÄÖ„Å´„Éï„Çß„Éº„Éâ
      return 1 - ((age - 10000) / 20000) * 0.7;
    }

    function extractAction(event) {
      const input = event.tool_input;
      if (!input) return null;

      if (input.description) {
        return input.description;
      }
      if (input.file_path) {
        const fileName = input.file_path.split('/').pop();
        return `${fileName} „ÇíÊìç‰Ωú‰∏≠`;
      }
      if (input.command) {
        return input.command.slice(0, 60) + (input.command.length > 60 ? '...' : '');
      }
      if (input.pattern) {
        return `Ê§úÁ¥¢: ${input.pattern}`;
      }
      return null;
    }

    function renderSessions() {
      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      // - endedÔºàSessionEndÂèó‰ø°Ê∏à„ÅøÔºâ„ÅØ1ÂàÜ„ÅßÊ∂à„Åà„Çã
      // - „Åù„Çå‰ª•Â§ñ„ÅØ30ÂàÜÊÆã„Çã
      const oneMinuteAgo = Date.now() - 60 * 1000;
      const thirtyMinutesAgo = Date.now() - 30 * 60 * 1000;
      const activeSessions = Array.from(sessions.values()).filter(session => {
        if (session.ended) {
          return session.lastSeen > oneMinuteAgo;
        }
        return session.lastSeen > thirtyMinutesAgo;
      });

      if (activeSessions.length === 0) {
        sessionsEl.innerHTML = '<div class="no-sessions">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó</div>';
        return;
      }

      sessionsEl.innerHTML = activeSessions.map(session => {
        const activeSubAgents = session.subAgents.filter(s => s.status === 'active');
        // inactive„ÅØË°®Á§∫„Åó„Å™„ÅÑ
        const allSubAgents = activeSubAgents;
        // session_id„ÅÆÂÖàÈ†≠7ÊñáÂ≠ó
        const shortId = session.id.slice(0, 7);

        return `
          <div class="session">
            <div class="session-header">
              <span class="session-project">${session.projectName}</span>
              <span class="session-id">${shortId}</span>
            </div>
            ${session.title ? `<div class="session-title">${session.title}</div>` : ''}
            ${session.speechHistory && session.speechHistory.length > 0 ? `
              <div class="speech-container">
                ${session.speechHistory.map((s, i) => {
                  const opacity = getActionOpacity(s.time);
                  const isOlder = i > 0;
                  return `<div class="session-speech${isOlder ? ' older' : ''}" style="opacity: ${opacity}">${s.text}</div>`;
                }).join('')}
              </div>
            ` : ''}
            ${session.currentAction ? `<div class="session-action" style="opacity: ${getActionOpacity(session.actionTime)}">${session.currentAction}</div>` : ''}
            ${allSubAgents.length > 0 ? `
              <div class="subagents">
                ${allSubAgents.map(sub => `
                  <div class="subagent">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="subagent-type ${sub.type}">${sub.type}</span>
                      <span class="subagent-action">ÂÆüË°å‰∏≠</span>
                    </div>
                    ${sub.currentAction ? `<div class="subagent-speech">${sub.currentAction}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function addEventToLog(event) {
      const el = document.createElement('div');
      el.className = 'event';
      const time = new Date(event.logged_at).toLocaleTimeString();
      // description„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí„ÄÅ„Å™„Åë„Çå„Å∞„ÉÑ„Éº„É´Âêç + „Ç§„Éô„É≥„ÉàÁ®ÆÂà•
      let desc = event.tool_input?.description;
      if (!desc && event.tool_name) {
        desc = `${event.tool_name}`;
      }
      if (!desc) {
        desc = event.hook_event_name;
      }
      el.textContent = `${time} ${desc}`;
      eventsEl.insertBefore(el, eventsEl.firstChild);

      while (eventsEl.children.length > MAX_EVENTS) {
        eventsEl.removeChild(eventsEl.lastChild);
      }
    }

    connect();

    // ÂÆöÊúüÁöÑ„Å´UI„ÇíÊõ¥Êñ∞Ôºà„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂèçÊò†Ôºâ
    setInterval(renderSessions, 2000);
  </script>
</body>
</html>
