<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC Visualizer</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
    }
    h1 {
      color: #7c3aed;
      font-size: 1.2em;
      margin: 0;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      margin-left: 12px;
    }
    .status.connected { background: #22c55e; color: #000; }
    .status.disconnected { background: #ef4444; color: #fff; }

    /* „Çª„ÉÉ„Ç∑„Éß„É≥ */
    .sessions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 800px;
    }
    .session {
      background: #111;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #7c3aed;
    }
    .session-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .session-project {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
    }
    .session-id {
      font-size: 0.75em;
      color: #555;
      font-family: monospace;
    }
    .session-title {
      font-size: 0.9em;
      color: #bbb;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .session-action {
      color: #888;
      font-size: 0.9em;
      margin-bottom: 12px;
      padding-left: 12px;
      border-left: 2px solid #333;
    }
    .speech-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .session-speech {
      background: #1a1a2e;
      color: #e0e0e0;
      font-size: 0.95em;
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
      border: 1px solid #2a2a4e;
      animation: speechFadeIn 0.3s ease-out;
      transition: opacity 0.5s ease, transform 0.3s ease;
    }
    .session-speech.older {
      font-size: 0.85em;
      padding: 6px 10px;
      background: #151525;
    }
    .session-speech::before {
      content: '"';
      font-size: 1.2em;
      color: #7c3aed;
      margin-right: 4px;
    }
    .session-speech::after {
      content: '"';
      font-size: 1.2em;
      color: #7c3aed;
      margin-left: 4px;
    }
    @keyframes speechFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà */
    .subagents {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-left: 12px;
    }
    .subagent {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
    }
    .subagent.inactive {
      opacity: 0.4;
    }
    .subagent-type {
      font-size: 0.8em;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      min-width: 60px;
      text-align: center;
    }
    .subagent-type.Explore { background: #8b5cf6; color: #fff; }
    .subagent-type.Plan { background: #f59e0b; color: #000; }
    .subagent-type.Bash { background: #3b82f6; color: #fff; }
    .subagent-type.unknown { background: #666; color: #fff; }
    .subagent-action {
      color: #aaa;
      font-size: 0.85em;
      flex: 1;
    }
    .subagent-speech {
      background: #1a2a1a;
      color: #c0e0c0;
      font-size: 0.9em;
      padding: 8px 12px;
      border-radius: 10px;
      margin-top: 6px;
      border: 1px solid #2a4a2a;
    }
    .subagent-speech::before {
      content: 'üí≠ ';
      font-size: 0.9em;
    }
    .subagent-status {
      font-size: 0.7em;
      color: #666;
    }

    .no-sessions {
      color: #555;
      font-size: 0.9em;
      text-align: center;
      padding: 40px;
    }

    /* „Çø„Ç§„É†„É©„Ç§„É≥ */
    .timeline-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 16px;
    }
    .timeline-lane {
      display: flex;
      align-items: flex-start;
      min-height: 80px;
      background: #111;
      border-radius: 8px;
      overflow: hidden;
      transition: opacity 0.3s;
    }
    .timeline-lane.idle {
      opacity: 0.4;
    }
    .session-id {
      font-size: 0.7em;
      color: #555;
      font-family: monospace;
    }
    .timeline-label {
      width: 180px;
      min-width: 180px;
      padding: 12px;
      background: #1a1a1a;
      border-right: 1px solid #333;
    }
    .timeline-label .project {
      font-weight: 600;
      color: #fff;
      font-size: 0.95em;
    }
    .timeline-label .title {
      font-size: 0.8em;
      color: #888;
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .timeline-label .speech {
      font-size: 0.75em;
      color: #7c3aed;
      margin-top: 6px;
      font-style: italic;
    }
    .timeline-label .current-action {
      font-size: 0.8em;
      color: #3b82f6;
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .timeline-label .active-subagents {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .subagent-badge {
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 4px;
      background: #333;
      color: #fff;
    }
    .subagent-badge.Explore { background: #8b5cf6; }
    .subagent-badge.Plan { background: #f59e0b; color: #000; }
    .subagent-badge.Bash { background: #3b82f6; }
    .timeline-svg {
      flex: 1;
      min-width: 600px;
      height: 80px;
    }
    .timeline-svg .lane-line {
      stroke: #333;
      stroke-width: 2;
    }
    .timeline-svg .event-point {
      fill: #7c3aed;
      cursor: pointer;
      transition: r 0.2s;
    }
    .timeline-svg .event-point:hover {
      r: 8;
    }
    .timeline-svg .event-point.SubagentStart { fill: #22c55e; }
    .timeline-svg .event-point.SubagentStop { fill: #ef4444; }
    .timeline-svg .event-point.PreToolUse { fill: #3b82f6; }
    .timeline-svg .event-point.PostToolUse { fill: #6366f1; }
    .timeline-svg .subagent-line {
      stroke: #22c55e;
      stroke-width: 1.5;
      stroke-dasharray: 4 2;
    }
    .timeline-svg text {
      fill: #888;
      font-size: 10px;
    }

    /* „Ç§„Éô„É≥„Éà„É≠„Ç∞ÔºàÂ∞è„Åï„Åè‰∏ã„Å´Ôºâ */
    .event-log {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #222;
    }
    .event-log h2 {
      font-size: 0.8em;
      color: #555;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .events {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8em;
      color: #666;
      max-height: 200px;
      overflow-y: auto;
    }
    .event {
      padding: 4px 8px;
      background: #111;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CC Visualizer</h1>
    <span id="status" class="status disconnected">disconnected</span>
  </header>

  <div id="sessions" class="sessions">
    <div class="no-sessions">„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó</div>
  </div>

  <div class="event-log">
    <h2>Event Log</h2>
    <div id="events" class="events"></div>
  </div>

  <script>
    const sessionsEl = document.getElementById('sessions');
    const eventsEl = document.getElementById('events');
    const statusEl = document.getElementById('status');
    const MAX_EVENTS = 20;

    // „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã
    const sessions = new Map();

    function connect() {
      const ws = new WebSocket(`ws://${location.host}/ws`);

      ws.onopen = () => {
        statusEl.textContent = 'connected';
        statusEl.className = 'status connected';
      };

      ws.onclose = () => {
        statusEl.textContent = 'disconnected';
        statusEl.className = 'status disconnected';
        setTimeout(connect, 2000);
      };

      ws.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);

          // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºàÂàùÊúüÁä∂ÊÖãÔºâ
          if (data.sessions) {
            sessions.clear();
            for (const session of data.sessions) {
              // eventHistory„ÇíÂàùÊúüÂåñ
              session.eventHistory = session.eventHistory || [];
              session.speechHistory = session.speechHistory || [];
              session.startTime = session.startTime || Date.now();
              sessions.set(session.id, session);
            }
            renderSessions();
            return;
          }

          // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
          if (data.type === 'title_update') {
            const session = sessions.get(data.sessionId);
            if (session) {
              session.title = data.title;
              session.lastSeen = Date.now();
              renderSessions();
            }
            return;
          }

          // Áô∫Ë©±Êõ¥Êñ∞
          if (data.type === 'speech_update') {
            const session = sessions.get(data.sessionId);
            if (session) {
              // Â±•Ê≠¥„Å´ËøΩÂä†ÔºàÂêå„ÅòÂÜÖÂÆπ„ÅØËøΩÂä†„Åó„Å™„ÅÑÔºâ
              if (!session.speechHistory) {
                session.speechHistory = [];
              }
              const lastSpeech = session.speechHistory[0];
              if (!lastSpeech || lastSpeech.text !== data.speech) {
                session.speechHistory.unshift({
                  text: data.speech,
                  time: Date.now()
                });
                // ÊúÄÂ§ß3‰ª∂‰øùÊåÅ
                if (session.speechHistory.length > 3) {
                  session.speechHistory.pop();
                }
              }
              session.lastSeen = Date.now();
              renderSessions();
            }
            return;
          }

          // ÈÄöÂ∏∏„Ç§„Éô„É≥„Éà
          handleEvent(data);
          addEventToLog(data);
        } catch (err) {
          console.error('Parse error:', err);
        }
      };
    }

    function handleEvent(event) {
      const sessionId = event.session_id;
      if (!sessionId) return;

      let session = sessions.get(sessionId);
      if (!session) {
        session = {
          id: sessionId,
          projectName: extractProjectName(event.cwd),
          subAgents: [],
          eventHistory: [], // „Çø„Ç§„É†„É©„Ç§„É≥Áî®„ÅÆ„Ç§„Éô„É≥„ÉàÂ±•Ê≠¥
          startTime: Date.now(),
          lastSeen: Date.now(),
        };
        sessions.set(sessionId, session);
      }
      session.lastSeen = Date.now();

      // „Ç§„Éô„É≥„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†Ôºà„Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫Áî®Ôºâ
      if (event.hook_event_name) {
        if (!session.eventHistory) session.eventHistory = [];
        session.eventHistory.push({
          type: event.hook_event_name,
          tool: event.tool_name,
          agentId: event.agent_id,
          agentType: event.agent_type,
          description: event.tool_input?.description,
          time: Date.now()
        });
        // ÊúÄÂ§ß100‰ª∂‰øùÊåÅÔºà5ÂàÜÂàÜ„Åè„Çâ„ÅÑÔºâ
        if (session.eventHistory.length > 100) {
          session.eventHistory.shift();
        }
      }

      switch (event.hook_event_name) {
        case 'SubagentStart':
          if (event.agent_id) {
            // Êó¢Â≠ò„ÅÆ„ÇíÊé¢„Åô
            let sub = session.subAgents.find(s => s.id === event.agent_id);
            if (!sub) {
              sub = { id: event.agent_id, type: event.agent_type || 'unknown', status: 'active' };
              session.subAgents.push(sub);
            } else {
              sub.status = 'active';
              sub.type = event.agent_type || sub.type;
            }
          }
          break;

        case 'SubagentStop':
          if (event.agent_id) {
            const sub = session.subAgents.find(s => s.id === event.agent_id);
            if (sub) {
              sub.status = 'inactive';
              sub.currentAction = null;
            }
          }
          break;

        case 'PreToolUse':
          const action = extractAction(event);
          if (event.agent_id) {
            const sub = session.subAgents.find(s => s.id === event.agent_id);
            if (sub && action) {
              sub.currentAction = action;
              sub.actionTime = Date.now();
            }
          } else if (action) {
            session.currentAction = action;
            session.actionTime = Date.now();
          }
          break;

        case 'PostToolUse':
          // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊ∂à„Åï„Å™„ÅÑÔºàÂêπ„ÅçÂá∫„Åó„ÅÆ„Çà„ÅÜ„Å´ÊÆã„ÅôÔºâ
          break;

        case 'SessionEnd':
          session.ended = true;
          session.currentAction = null;
          session.subAgents.forEach(s => {
            s.status = 'inactive';
            s.currentAction = null;
          });
          break;
      }

      renderSessions();
    }

    function extractProjectName(cwd) {
      if (!cwd) return 'unknown';
      const parts = cwd.split('/');
      return parts[parts.length - 1] || 'unknown';
    }

    // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂè§„Åï„Å´Âøú„Åò„Å¶opacity„ÇíË®àÁÆóÔºà10Áßí„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÈñãÂßã„ÄÅ30Áßí„ÅßÊ∂à„Åà„ÇãÔºâ
    function getActionOpacity(actionTime) {
      if (!actionTime) return 0.3;
      const age = Date.now() - actionTime;
      if (age < 10000) return 1; // 10Áßí‰ª•ÂÜÖ„ÅØ100%
      if (age > 30000) return 0.3; // 30Áßí‰ª•‰∏ä„ÅØ30%
      // 10-30Áßí„ÅØÂæê„ÄÖ„Å´„Éï„Çß„Éº„Éâ
      return 1 - ((age - 10000) / 20000) * 0.7;
    }

    function extractAction(event) {
      const input = event.tool_input;
      if (!input) return null;

      if (input.description) {
        return input.description;
      }
      if (input.file_path) {
        const fileName = input.file_path.split('/').pop();
        return `${fileName} „ÇíÊìç‰Ωú‰∏≠`;
      }
      if (input.command) {
        return input.command.slice(0, 60) + (input.command.length > 60 ? '...' : '');
      }
      if (input.pattern) {
        return `Ê§úÁ¥¢: ${input.pattern}`;
      }
      return null;
    }

    function renderSessions() {
      // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      const oneMinuteAgo = Date.now() - 60 * 1000;
      const thirtyMinutesAgo = Date.now() - 30 * 60 * 1000;
      const activeSessions = Array.from(sessions.values()).filter(session => {
        if (session.ended) {
          return session.lastSeen > oneMinuteAgo;
        }
        return session.lastSeen > thirtyMinutesAgo;
      });

      if (activeSessions.length === 0) {
        sessionsEl.innerHTML = '<div class="no-sessions">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó</div>';
        return;
      }

      // „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫ÁØÑÂõ≤ÔºàÁõ¥Ëøë5ÂàÜÔºâ
      const now = Date.now();
      const timeWindow = 5 * 60 * 1000; // 5ÂàÜ
      const startTime = now - timeWindow;
      const svgWidth = 600;
      const timeToX = (t) => Math.max(0, Math.min(svgWidth, ((t - startTime) / timeWindow) * svgWidth));

      sessionsEl.innerHTML = `<div class="timeline-container">
        ${activeSessions.map(session => {
          const events = session.eventHistory || [];
          const speech = session.speechHistory?.[0]?.text || '';

          // „É°„Ç§„É≥„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„Ç§„Éô„É≥„Éà
          const mainEvents = events.filter(e => !e.agentId && e.type === 'PreToolUse');

          // „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„Ç§„Éô„É≥„ÉàÔºàagentId„Åß„Ç∞„É´„Éº„ÉóÂåñÔºâ
          const subAgentEvents = {};
          events.forEach(e => {
            if (e.agentId) {
              if (!subAgentEvents[e.agentId]) {
                subAgentEvents[e.agentId] = { type: e.agentType, events: [] };
              }
              subAgentEvents[e.agentId].events.push(e);
            }
          });

          // SVGË¶ÅÁ¥†„ÇíÁîüÊàê
          const mainY = 25;
          const subY = 55;

          let svgContent = `
            <!-- „É°„Ç§„É≥„É©„Ç§„É≥ -->
            <line class="lane-line" x1="0" y1="${mainY}" x2="${svgWidth}" y2="${mainY}" />
            <!-- ÁèæÂú®‰ΩçÁΩÆ„Éû„Éº„Ç´„Éº -->
            <circle cx="${svgWidth - 5}" cy="${mainY}" r="4" fill="#7c3aed" opacity="0.5">
              <animate attributeName="r" values="4;6;4" dur="1s" repeatCount="indefinite" />
            </circle>
          `;

          // „É°„Ç§„É≥„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„Ç§„Éô„É≥„Éà„Éù„Ç§„É≥„Éà
          let lastLabelX = -50; // „É©„Éô„É´ÈáçË§áÈò≤Ê≠¢Áî®
          mainEvents.forEach((e, i) => {
            const x = timeToX(e.time);
            const displayX = Math.min(x, svgWidth - 20);
            if (displayX >= 10) {
              // „Éù„Ç§„É≥„Éà
              svgContent += `<circle class="event-point ${e.type}" cx="${displayX}" cy="${mainY}" r="5" />`;
              // „É©„Éô„É´Ôºà„ÉÑ„Éº„É´ÂêçÔºâ- 40px‰ª•‰∏äÈõ¢„Çå„Å¶„Åü„ÇâË°®Á§∫
              if (displayX - lastLabelX > 40) {
                const label = e.tool || e.type;
                svgContent += `<text x="${displayX}" y="${mainY + 15}" text-anchor="middle" fill="#888" font-size="9">${label}</text>`;
                lastLabelX = displayX;
              }
            }
          });

          // „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆÁ∑ö„Å®„Ç§„Éô„É≥„Éà
          let subIndex = 0;
          Object.entries(subAgentEvents).forEach(([agentId, data]) => {
            const yOffset = subY + subIndex * 20;
            const agentEvents = data.events.filter(e => e.type === 'PreToolUse' || e.type === 'SubagentStart');
            if (agentEvents.length > 0) {
              const firstX = timeToX(agentEvents[0].time);
              const lastEvent = agentEvents[agentEvents.length - 1];
              const lastX = timeToX(lastEvent.time);

              // ÂàÜÂ≤êÁ∑ö
              svgContent += `<line class="subagent-line" x1="${firstX}" y1="${mainY}" x2="${firstX}" y2="${yOffset}" />`;
              svgContent += `<line class="subagent-line" x1="${firstX}" y1="${yOffset}" x2="${lastX + 10}" y2="${yOffset}" />`;

              // „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà„É©„Éô„É´
              svgContent += `<text x="${firstX + 5}" y="${yOffset - 3}" fill="#22c55e" font-size="9">${data.type}</text>`;

              // „Ç§„Éô„É≥„Éà„Éù„Ç§„É≥„Éà„Å®„É©„Éô„É´
              agentEvents.filter(e => e.type === 'PreToolUse').forEach(e => {
                const x = timeToX(e.time);
                svgContent += `<circle class="event-point PreToolUse" cx="${x}" cy="${yOffset}" r="4" />`;
                svgContent += `<text x="${x}" y="${yOffset + 12}" text-anchor="middle" fill="#666" font-size="8">${e.tool || ''}</text>`;
              });
            }
            subIndex++;
          });

          // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà
          const activeSubAgents = (session.subAgents || []).filter(s => s.status === 'active');

          // ÊúÄËøëÊõ¥Êñ∞„Åå„ÅÇ„Å£„Åü„Åã„Å©„ÅÜ„ÅãÔºà1ÂàÜ‰ª•ÂÜÖÔºâ
          const isRecent = session.lastSeen > Date.now() - 60 * 1000;
          const shortId = session.id.slice(0, 7);

          return `
            <div class="timeline-lane${isRecent ? '' : ' idle'}" data-session-id="${session.id}">
              <div class="timeline-label">
                <div class="project">${session.projectName} <span class="session-id">${shortId}</span></div>
                ${session.title ? `<div class="title">${session.title}</div>` : ''}
                ${speech ? `<div class="speech">"${speech.slice(0, 40)}..."</div>` : ''}
                ${session.currentAction ? `<div class="current-action">‚Üí ${session.currentAction}</div>` : ''}
                ${activeSubAgents.length > 0 ? `
                  <div class="active-subagents">
                    ${activeSubAgents.map(s => `<span class="subagent-badge ${s.type}">${s.type}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
              <svg class="timeline-svg" viewBox="0 0 ${svgWidth} 80" preserveAspectRatio="xMaxYMid meet">
                ${svgContent}
              </svg>
            </div>
          `;
        }).join('')}
      </div>`;
    }

    function addEventToLog(event) {
      const el = document.createElement('div');
      el.className = 'event';
      const time = new Date(event.logged_at).toLocaleTimeString();
      // description„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí„ÄÅ„Å™„Åë„Çå„Å∞„ÉÑ„Éº„É´Âêç + „Ç§„Éô„É≥„ÉàÁ®ÆÂà•
      let desc = event.tool_input?.description;
      if (!desc && event.tool_name) {
        desc = `${event.tool_name}`;
      }
      if (!desc) {
        desc = event.hook_event_name;
      }
      el.textContent = `${time} ${desc}`;
      eventsEl.insertBefore(el, eventsEl.firstChild);

      while (eventsEl.children.length > MAX_EVENTS) {
        eventsEl.removeChild(eventsEl.lastChild);
      }
    }

    connect();

    // ÂÆöÊúüÁöÑ„Å´UI„ÇíÊõ¥Êñ∞Ôºà„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂèçÊò†Ôºâ
    setInterval(renderSessions, 2000);
  </script>
</body>
</html>
